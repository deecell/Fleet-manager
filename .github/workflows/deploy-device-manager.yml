# =============================================================================
# Deecell Fleet Tracking - Device Manager Deployment
# Deploys the Device Manager to EC2 via S3
# =============================================================================

name: Deploy Device Manager

on:
  push:
    branches: [main]
    paths:
      - 'device-manager/**'
      - '.github/workflows/deploy-device-manager.yml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even without changes'
        required: false
        default: 'false'

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  DEVICE_MANAGER_BUCKET: ${{ secrets.DEVICE_MANAGER_BUCKET }}
  ASG_NAME: deecell-fleet-production-device-manager-asg

permissions:
  contents: read
  id-token: write

jobs:
  # ===========================================================================
  # Job 1: Build and Package
  # ===========================================================================
  build:
    name: Build Package
    runs-on: ubuntu-latest

    outputs:
      artifact_key: ${{ steps.upload.outputs.artifact_key }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3

      - name: Package Device Manager
        run: |
          cd device-manager
          
          # Create package directory
          mkdir -p package
          
          # Copy application files
          cp -r app package/
          cp -r lib package/
          cp -r src package/
          cp -r build package/ 2>/dev/null || echo "No pre-built binaries"
          cp package.json package/
          cp binding.gyp package/
          
          # Create version info
          echo "{\"version\": \"${{ github.sha }}\", \"built\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\", \"branch\": \"${{ github.ref_name }}\"}" > package/version.json
          
          # Create deployment zip
          cd package
          zip -r ../device-manager-${{ github.sha }}.zip .
          cd ..
          
          # Also create 'latest' zip
          cp device-manager-${{ github.sha }}.zip device-manager-latest.zip
          
          echo "Package created:"
          ls -la *.zip

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload to S3
        id: upload
        run: |
          cd device-manager
          
          # Upload versioned artifact
          aws s3 cp device-manager-${{ github.sha }}.zip \
            s3://${{ env.DEVICE_MANAGER_BUCKET }}/device-manager-${{ github.sha }}.zip
          
          # Upload as 'latest'
          aws s3 cp device-manager-latest.zip \
            s3://${{ env.DEVICE_MANAGER_BUCKET }}/device-manager-latest.zip
          
          echo "artifact_key=device-manager-${{ github.sha }}.zip" >> $GITHUB_OUTPUT
          
          echo "Uploaded to S3:"
          aws s3 ls s3://${{ env.DEVICE_MANAGER_BUCKET }}/ --human-readable | tail -5

  # ===========================================================================
  # Job 2: Deploy to EC2
  # ===========================================================================
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' || github.event.inputs.force_deploy == 'true'

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get EC2 Instance IDs
        id: get-instances
        run: |
          INSTANCE_IDS=$(aws autoscaling describe-auto-scaling-groups \
            --auto-scaling-group-names ${{ env.ASG_NAME }} \
            --query 'AutoScalingGroups[0].Instances[?LifecycleState==`InService`].InstanceId' \
            --output text)
          
          if [ -z "$INSTANCE_IDS" ]; then
            echo "No running instances found in ASG"
            echo "has_instances=false" >> $GITHUB_OUTPUT
          else
            echo "Found instances: $INSTANCE_IDS"
            echo "instance_ids=$INSTANCE_IDS" >> $GITHUB_OUTPUT
            echo "has_instances=true" >> $GITHUB_OUTPUT
          fi

      - name: Deploy via SSM
        if: steps.get-instances.outputs.has_instances == 'true'
        run: |
          INSTANCE_IDS="${{ steps.get-instances.outputs.instance_ids }}"
          
          for INSTANCE_ID in $INSTANCE_IDS; do
            echo "Deploying to instance: $INSTANCE_ID"
            
            # Send SSM command to run deploy script
            COMMAND_ID=$(aws ssm send-command \
              --instance-ids "$INSTANCE_ID" \
              --document-name "AWS-RunShellScript" \
              --parameters 'commands=["/opt/device-manager/deploy.sh"]' \
              --timeout-seconds 300 \
              --output text \
              --query 'Command.CommandId')
            
            echo "Command ID: $COMMAND_ID"
            
            # Wait for command to complete
            for i in {1..30}; do
              STATUS=$(aws ssm list-command-invocations \
                --command-id "$COMMAND_ID" \
                --instance-id "$INSTANCE_ID" \
                --query 'CommandInvocations[0].Status' \
                --output text)
              
              echo "Status: $STATUS"
              
              if [ "$STATUS" = "Success" ]; then
                echo "Deployment successful on $INSTANCE_ID"
                break
              elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "TimedOut" ]; then
                echo "Deployment failed on $INSTANCE_ID"
                aws ssm get-command-invocation \
                  --command-id "$COMMAND_ID" \
                  --instance-id "$INSTANCE_ID" \
                  --query 'StandardErrorContent' \
                  --output text
                exit 1
              fi
              
              sleep 10
            done
          done

      - name: Verify deployment
        if: steps.get-instances.outputs.has_instances == 'true'
        run: |
          echo "Waiting for service to stabilize..."
          sleep 30
          
          echo "Deployment complete!"
          echo "Check CloudWatch logs for service status"

      - name: No instances warning
        if: steps.get-instances.outputs.has_instances == 'false'
        run: |
          echo "::warning title=No Instances::No running EC2 instances in ASG. Package uploaded to S3 - will be deployed when instances start."

  # ===========================================================================
  # Job 3: Notify
  # ===========================================================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()

    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ] || [ "${{ needs.deploy.result }}" == "skipped" ]; then
            echo "Device Manager deployment successful!"
            echo "::notice title=Device Manager Deployed::Package ${{ needs.build.outputs.artifact_key }} deployed"
          else
            echo "Device Manager deployment failed!"
            echo "::error title=Deployment Failed::Check the logs for details."
            exit 1
          fi
